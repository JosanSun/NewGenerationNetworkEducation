var T=require("common:widget/lib/tangram/base/base.js");require("common:widget/lib/tangram/flash/fileUploader/fileUploader.js");var tmp_width=tmp_height=0,maxSize=5242880;!function(){function get_all_pic(){var e=$("#feel-editor .edui-img-pic"),i=[];return $.each(e,function(e,t){i.push({src:$(t).attr("encrypt"),type:"img",width:$(t).width(),height:$(t).height()})}),i}var uploadImgWgt=function(e,i){var t={createOptions:{id:"",url:"/static/common/flash/multiupload.swf",width:120,height:120,wmode:"transparent",container:e,tabIndex:-1},maxNum:2,maxSize:5120,selectFile:function(){},exceedMaxSize:function(){},deleteFile:function(){},uploadStart:function(){},uploadProgress:function(){},uploadComplete:function(){},uploadError:function(){}};return T.object.each(t.createOptions,function(e,a){i[a]&&(t.createOptions[a]=i[a],delete i[a])}),i=T.object.extend(t,i),new T.flash.fileUploader(i)},_dis_err_tip=function(e){currentDialog.showTip(e),setTimeout(function(){currentDialog.hideTip()},2e3)},utils=UM.utils,browser=UM.browser,Base={checkURL:function(e){return e?(e=utils.trim(e),e.length<=0?!1:(0!==e.search(/http:\/\/|https:\/\//)&&(e+="http://"),e=e.replace(/\?[\s\S]*$/,""),/(.gif|.jpg|.jpeg|.png)$/i.test(e)?e:!1)):!1},getAllPic:function(e,i){var t=[],a=$(e,i);return $.each(a,function(e,i){return $(i).removeAttr("width").removeAttr("height"),t.push({_src:i.src,src:i.src,"class":"edui-img-pic",encrypt:$(i).attr("encrypt")})}),t},scale:function(e,i,t,a){var o,n=0,r=0,d=e.width||t,s=e.height||a;return(d>i||s>i)&&(d>=s?(n=d-i)&&(o=(n/d).toFixed(2),e.height=s-s*o,e.width=i):(r=s-i)&&(o=(r/s).toFixed(2),e.width=d-d*o,e.height=i)),this},close:function(e){return e.css({top:(e.parent().height()-e.height())/2,left:(e.parent().width()-e.width())/2}).prev().on("click",function(){$(this).parent().remove().hasClass("edui-image-upload-item")&&(Upload.showCount--,Upload.updateView())}),this},createImgBase64:function(e,i,t){if(browser.webkit)e.src=window.webkitURL.createObjectURL(i);else if(browser.gecko)e.src=window.URL.createObjectURL(i);else{var a=new FileReader;a.onload=function(){e.src=this.result,t.append(e)},a.readAsDataURL(i)}},callback:function(e,i,t,a,o){if("SUCCESS"==a.toUpperCase()){Upload.showCount++;var n=$("<img src='"+t+"' encrypt='"+o+"' class='edui-image-pic' />"),r=$("<div class='edui-image-item edui-image-upload-item'><div class='edui-image-close'></div></div>").append(n);$(".edui-image-upload1",i).before(r).show().addClass("edui-image-upload2"),n.on("load",function(){Base.scale(this,120),Base.close($(this)),$(".edui-image-content",i).focus()})}else _dis_err_tip(a);Upload.toggleMask()}},Upload={showCount:0,uploadTpl:'<div class="edui-image-upload%%"><span class="edui-image-icon"></span><div id="edui-img-uploader" class="edui-img-uploader"></div></div>',init:function(e,i){var t=this;return t.editor=e,t.dialog=i,t.render(".edui-image-content",1),t.submit(),$(".edui-image-upload1").hover(function(){$(".edui-image-icon",this).toggleClass("hover")}),t},render:function(e,i){var t=this;return $(e,t.dialog).append($(t.uploadTpl.replace(/%%/g,i))),t},config:function(e){var i=this,t=i.editor.options.imageUrl;return t=t+(-1==t.indexOf("?")?"?":"&")+"editorid="+i.editor.id,$("form",$(e,i.dialog)).attr("action",t),i},uploadComplete:function(r){var me=this;try{var json=eval("("+r+")");Base.callback(me.editor,me.dialog,json.timgurl,json.state,json.encrypt)}catch(e){var lang=me.editor.getLang("image");Base.callback(me.editor,me.dialog,"",lang&&lang.uploadError||"Error!")}},submit:function(e){var i=this,t=uploadImgWgt("edui-img-uploader",{selectFile:function(e){tmp_width=e.files[0].width,tmp_height=e.files[0].height;var i=$("#feel-editor .edui-img-pic").length,a=$(".edui-image-content .edui-image-pic").length,o=i+a;return o>19?void _dis_err_tip("上传失败：您最多只能上传20张图片"):e.files[0].size>maxSize?void _dis_err_tip("上传失败：图片大小不能超过5M"):/\.(jpg|jpeg|png|bmp)$/.test(e.files[0].name.toLowerCase())?void t.upload("/submit/picture?method=uploadPic","file",{crop:"wh=480,480"},-1):void _dis_err_tip("上传失败：上传文件格式不对，只能上传指定格式的图片")},uploadStart:function(){i.toggleMask("上传中...."),e&&e()},uploadProgress:function(){},uploadComplete:function(e){T.json.parse(e.data);setTimeout(function(){i.uploadComplete(e.data)},500)},uploadError:function(){},vars:{fileType:'{"description":"图片", "extension":"*.bmp;*.jpeg;*.png;*.jpg"}'}});t.setFileType([{description:"图片文件",extention:"*.jpg;*.jpeg;*.JPG;*.bmp;*.BMP;*.png;*.PNG"},{description:"jpeg",extention:"*.jpg;*.jpeg;*.JPG"},{description:"bmp",extention:"*.bmp"},{description:"png",extention:"*.png;*.PNG"}]),t.setMaxNum(1)},updateInput:function(e){$(".edui-image-file",this.dialog).each(function(i,t){t.parentNode.replaceChild(e.cloneNode(!0),t)})},updateView:function(){0===Upload.showCount&&$(".edui-image-upload1",this.dialog).removeClass("edui-image-upload2")},drag:function(){var e=this;UM.browser.ie9below||e.dialog.find(".edui-image-content").on("drop",function(i){var t=i.originalEvent.dataTransfer.files,a=document.createElement("img"),o=!1;$.each(t,function(i,n){if(/^image/.test(n.type)){Base.createImgBase64(a,n,e.dialog);var r=new XMLHttpRequest;r.open("post",e.editor.getOpt("imageUrl"),!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest");var d=new FormData;d.append(e.editor.getOpt("imageFieldName"),n),r.send(d),r.addEventListener("load",function(o){var n=o.target.response;setTimeout(function(){e.uploadComplete(n)},500),i==t.length-1&&$(a).remove()}),o=!0}}),o&&(i.preventDefault(),e.toggleMask("上传中..."))}).on("dragover",function(e){e.preventDefault()})},toggleMask:function(e){var i=this,t=$(".edui-image-mask",i.dialog);if(e)t.addClass("edui-active").html(e);else{if(t.removeClass("edui-active").html(),Upload.showCount>0)return i;$(".edui-image-upload1",i.dialog).css("display","block")}return i}},$tab=null,currentDialog=null;UM.registerWidget("image",{tpl:'<link rel="stylesheet" type="text/css" href="<%=image_url%>image.css"><div class="edui-image-wrapper"><ul class="edui-tab-nav"><li class="edui-tab-item edui-active"><a data-context=".edui-image-local" class="edui-tab-text"><%=lang_tab_local%></a></li></ul><div class="edui-tab-content"><div class="edui-image-local edui-tab-pane edui-active"><div class="edui-image-content"></div><div class="edui-image-mask"></div></div></div></div>',initContent:function(e,i){var t=e.getLang("image")["static"],a=$.extend({},t,{image_url:UMEDITOR_CONFIG.UMEDITOR_HOME_URL+"dialogs/image/"});if(Upload.showCount=0,t)var o=$.parseTmpl(this.tpl,a);currentDialog=i.edui(),this.root().html(o)},initEvent:function(e,i){$tab=$.eduitab({selector:".edui-image-wrapper"}).edui().on("beforeshow",function(e){e.stopPropagation()}),Upload.init(e,i)},buttons:{ok:{exec:function(e,i){var t="",a=$tab.activate();0==a?t=".edui-image-content .edui-image-pic":1==a&&(t=".edui-image-searchRes .edui-image-pic");var o=Base.getAllPic(t,i,e);-1!=a&&e.execCommand("insertimage",o)}},cancel:{}},width:500,height:250},function(e,i,t,a){Base.callback(e,i,t,a)})}();